otk.version: "1"

otk.define:
  packages:
    build:
      otk.external.osbuild-gen-depsolve-dnf4:
        architecture: x86_64
        module_platform_id: c9s
        releasever: "9"
        repositories:
          otk.include: "common/repositories/x86_64.yaml"
        packages:
          include:
            - dosfstools
            - clevis-luks
            - iwl105-firmware
            - glibc
            - xfsprogs
            - coreutils
            - iwl100-firmware
            - iwl2030-firmware
            - dracut-config-generic
            - microcode_ctl
            - iwl6050-firmware
            - iwl5150-firmware
            - iwl135-firmware
            - platform-python
            - xz
            - shim-x64
            - grub2-pc
            - iwl3160-firmware
            - iwl2000-firmware
            - selinux-policy-targeted
            - python3
            - iwl5000-firmware
            - iwl1000-firmware
            - cryptsetup
            - grub2-efi-x64
            - systemd
            - efibootmgr
            - rpm-ostree
            - clevis
            - lvm2
          exclude: []
  commit:
    otk.external.otk-resolve-ostree-commit:
      url: http://example.com/repo
      ref: centos/9/x86_64/edge
  osname: rhel-edge
  remote: ${osname}
  luks_uuid: "5a8535ea-d662-4a9a-af6b-76b51fe4b522"  # TODO: will be generated by partition table
  kernel_opts: "luks.uuid=${luks_uuid} modprobe.blacklist=vc4 rw coreos.no_persist_ip ignition.platform.id=metal $ignition_firstboot"
  kernel_opts_list:
    - "luks.uuid=${luks_uuid}"
    - "modprobe.blacklist=vc4 rw coreos.no_persist_ip"
    - "ignition.platform.id=metal"
    - "$ignition_firstboot"
  img_filename: disk.img

otk.target.osbuild:
  pipelines:
    - otk.include: "pipeline/build/generic.yaml"
    - otk.include: "pipeline/ostree-deployment.yaml"
    - otk.include: "pipeline/image/luks-lvm-x86_64.yaml"
    - name: xz
      build: name:build
      stages:
        - type: org.osbuild.xz
          inputs:
            file:
              type: org.osbuild.files
              origin: org.osbuild.pipeline
              references:
                name:image:
                  file: ${img_filename}
          options:
            filename: image.raw.xz
  sources:
    otk.op.join:
      values:
        - otk.external.osbuild-make-depsolve-dnf4-curl-source:
            packagesets:
              - ${packages.build}
        - otk.external.otk-make-ostree-source:
            ${commit}
